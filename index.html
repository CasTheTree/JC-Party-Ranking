<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Song Scoring Dashboard</title>
  <style>
    :root{
      --bg:#0b0b0c;          /* page background (not exported) */
      --ink:#e8e8ea;         /* primary text */
      --muted:#a7a7ab;       /* secondary text */
      --accent:#7dd3fc;      /* ui highlights */
      --card:#111114;        /* card background (can be toggled transparent on export) */
      --ring:#2a2a31;        /* outlines */
      --green:#16a34a;       /* highest */
      --red:#dc2626;         /* lowest */
      --yellow:#facc15;      /* submitter mark */
    }
    html,body{height:100%}
    body{
      margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg); color:var(--ink);
      display:flex; flex-direction:column;
    }
    header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px); background:linear-gradient(180deg, #0b0b0ccc, #0b0b0c80 70%, transparent);}
    .container{max-width:1100px; margin:0 auto; padding:20px;}
    h1{font-size:clamp(22px, 2.6vw, 30px); margin:0 0 8px 0}
    .toolbar{display:grid; gap:10px; grid-template-columns: repeat(12,1fr); align-items:end}
    .toolbar .block{grid-column: span 3; min-width:0}
    .toolbar .block.wide{grid-column: span 6}
    label{display:block; font-size:12px; letter-spacing:.02em; color:var(--muted); margin:0 0 4px}
    input, select, button, textarea{
      background:#0f0f12; color:var(--ink); border:1px solid var(--ring); border-radius:10px; padding:10px 12px; width:100%; outline:none;
    }
    input[type="number"]{appearance:textfield}
    input:focus, select:focus, textarea:focus{border-color:#3b82f6; box-shadow:0 0 0 2px #3b82f640}
    button{cursor:pointer; border:1px solid #2b2b33; background:linear-gradient(180deg,#1b1b20,#121216); font-weight:600}
    button.primary{border-color:#2563eb; background:linear-gradient(180deg,#2563eb,#1d4ed8); color:white}
    button.ghost{background:transparent}
    .row{display:flex; gap:10px}

    /* Roster table */
    .roster{margin-top:12px; display:grid; grid-template-columns: 1fr auto; gap:8px;}
    .roster input{width:100%}

    /* Song entry form */
    .song-form{margin-top:18px; padding:16px; border:1px dashed var(--ring); border-radius:14px}
    .song-grid{display:grid; gap:10px; grid-template-columns: repeat(12,1fr)}
    .song-grid .span4{grid-column: span 4}
    .song-grid .span12{grid-column: 1 / -1}

    /* Cards */
    .cards{display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:16px; margin-top:18px}
    .card{position:relative; background:var(--card); border:1px solid var(--ring); border-radius:18px; padding:16px; display:flex; flex-direction:column; gap:8px}
    .card.compact{padding:12px; border-radius:14px}
    .card.borderless{border-color:transparent; background:transparent}
    .title{font-size:18px; font-weight:700}
    .artist{font-size:14px; color:var(--muted); margin-top:-2px; border-bottom:1px dashed var(--ring); padding-bottom:8px}
    .scores{display:grid; grid-template-columns: 1fr auto; row-gap:6px; column-gap:8px; align-items:center}
    .badge{display:inline-flex; align-items:center; gap:6px}
    .chip{font-size:11px; border-radius:999px; padding:2px 6px; border:1px solid var(--ring); color:var(--muted)}
    .score{font-variant-numeric:tabular-nums; font-weight:700}
    .score.high{color:var(--green)}
    .score.low{color:var(--red)}
    .markN{display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:4px; background:var(--yellow); color:#111; font-size:10px; font-weight:900}
    .avg{margin-top:6px; font-weight:700}
    .avg small{color:var(--muted); font-weight:500}
    .card-actions{display:flex; gap:8px; margin-top:8px}

    .empty{border:1px dashed var(--ring); border-radius:14px; padding:20px; color:var(--muted); text-align:center}

    @media (max-width:840px){
      .toolbar .block{grid-column: span 6}
      .toolbar .block.wide{grid-column: 1 / -1}
      .song-grid .span4{grid-column: span 6}
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>ðŸŽµ Song Scoring Dashboard</h1>
      <div class="toolbar" role="region" aria-label="Controls">
        <div class="block">
          <label for="peopleCount">Number of people</label>
          <input id="peopleCount" type="number" min="1" value="5" />
        </div>
        <div class="block wide">
          <label>People (names)</label>
          <div id="roster" class="roster" aria-live="polite"></div>
        </div>
        <div class="block">
          <label for="layoutStyle">Layout</label>
          <select id="layoutStyle">
            <option value="standard">Standard</option>
            <option value="compact">Compact</option>
            <option value="borderless">Borderless / Transparent</option>
          </select>
        </div>
        <div class="block">
          <label for="sortBy">Sort by</label>
          <select id="sortBy">
            <option value="avg_desc">Average (High â†’ Low)</option>
            <option value="avg_asc">Average (Low â†’ High)</option>
            <option value="title_asc">Title (A â†’ Z)</option>
            <option value="artist_asc">Artist (A â†’ Z)</option>
          </select>
        </div>
        <div class="block">
          <label>&nbsp;</label>
          <button id="exportAll" title="Export all cards as transparent PNGs">Export All PNGs</button>
        </div>
      </div>

      <form id="songForm" class="song-form" autocomplete="off">
        <div class="song-grid">
          <div class="span4">
            <label for="title">Song title</label>
            <input id="title" required placeholder="e.g., Dreams" />
          </div>
          <div class="span4">
            <label for="artist">Artist</label>
            <input id="artist" required placeholder="e.g., Fleetwood Mac" />
          </div>
          <div class="span4">
            <label for="submitter">Submitter</label>
            <input id="submitter" required placeholder="Pick from roster or type" list="rosterList" />
            <datalist id="rosterList"></datalist>
          </div>
          <div class="span12">
            <label>Scores (per person)</label>
            <div id="scoreInputs" class="row" style="flex-wrap:wrap"></div>
          </div>
          <div class="span4">
            <label for="avgOverride">Average (optional â€” you can paste yours)</label>
            <input id="avgOverride" type="number" step="0.01" placeholder="Leave blank to auto-calc" />
          </div>
          <div class="span4">
            <label>&nbsp;</label>
            <button class="primary" type="submit">Add song</button>
          </div>
          <div class="span4">
            <label>&nbsp;</label>
            <button type="button" id="clearForm" class="ghost">Clear</button>
          </div>
        </div>
      </form>
    </div>
  </header>

  <main class="container" style="padding-top:6px; padding-bottom:40px">
    <section id="cards" class="cards" aria-live="polite">
      <div class="empty" id="emptyState">No songs yet â€” add one above âœ¨</div>
    </section>
  </main>

  <!-- html2canvas for export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const peopleCountEl = document.getElementById('peopleCount');
    const rosterEl = document.getElementById('roster');
    const datalistEl = document.getElementById('rosterList');
    const scoreInputsEl = document.getElementById('scoreInputs');
    const songForm = document.getElementById('songForm');
    const cardsEl = document.getElementById('cards');
    const layoutStyleEl = document.getElementById('layoutStyle');
    const sortByEl = document.getElementById('sortBy');
    const exportAllBtn = document.getElementById('exportAll');

    let roster = ['Alice','Bob','Charlie','Dana','Eli'];
    let songs = []; // {id,title,artist,submitter,scores:{name:value}, avg}

    /** Utilities */
    const uid = () => Math.random().toString(36).slice(2,9);
    const clamp = (n, min, max) => Math.min(Math.max(n, min), max);
    const sanitizeFilename = (s) => s.replace(/[\/:*?"<>|]/g,'_').slice(0,80);

    function renderRosterInputs(){
      rosterEl.innerHTML = '';
      datalistEl.innerHTML = '';
      roster.forEach((name, i)=>{
        const nameInput = document.createElement('input');
        nameInput.value = name;
        nameInput.placeholder = `Person ${i+1}`;
        nameInput.addEventListener('change', ()=>{
          roster[i] = nameInput.value.trim();
          rebuildScoreInputs();
          fillDatalist();
          refreshAllCards();
        });
        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'âœ•';
        removeBtn.type = 'button';
        removeBtn.style.width='42px';
        removeBtn.addEventListener('click', ()=>{
          roster.splice(i,1);
          peopleCountEl.value = roster.length;
          renderRosterInputs();
          rebuildScoreInputs();
          fillDatalist();
          refreshAllCards();
        });
        rosterEl.appendChild(nameInput);
        rosterEl.appendChild(removeBtn);

        const opt = document.createElement('option');
        opt.value = name; datalistEl.appendChild(opt);
      });
    }

    function fillDatalist(){
      datalistEl.innerHTML = '';
      roster.forEach(n=>{ const o=document.createElement('option'); o.value=n; datalistEl.appendChild(o);});
    }

    function rebuildScoreInputs(){
      scoreInputsEl.innerHTML = '';
      roster.forEach((name, idx)=>{
        const wrap = document.createElement('div');
        wrap.style.minWidth='160px'; wrap.style.flex='1 1 160px';
        const lab = document.createElement('label'); lab.textContent = name || `Person ${idx+1}`; lab.style.display='block'; lab.style.color='var(--muted)'; lab.style.fontSize='12px'; lab.style.marginBottom='4px';
        const inp = document.createElement('input');
        inp.type='number'; inp.step='0.01'; inp.placeholder='score';
        inp.dataset.person = name || `Person ${idx+1}`;
        wrap.appendChild(lab); wrap.appendChild(inp);
        scoreInputsEl.appendChild(wrap);
      });
    }

    peopleCountEl.addEventListener('change', ()=>{
      const n = clamp(parseInt(peopleCountEl.value||'0',10),1,50);
      const diff = n - roster.length;
      if(diff>0){ for(let i=0;i<diff;i++){ roster.push(`Person ${roster.length+1}`);} }
      if(diff<0){ roster.splice(n); }
      renderRosterInputs();
      rebuildScoreInputs();
      fillDatalist();
      refreshAllCards();
    });

    function computeAverage(scores){
      const vals = Object.values(scores).map(v=> typeof v==="number"? v : parseFloat(v)).filter(v=>!Number.isNaN(v));
      if(!vals.length) return 0;
      return vals.reduce((a,b)=>a+b,0)/vals.length;
    }

    function addSong(data){
      songs.push(data); rerenderCards();
    }

    function getExtrema(scores){
      const entries = Object.entries(scores).filter(([,v])=>v!=='' && v!=null && !Number.isNaN(parseFloat(v)));
      if(entries.length===0) return {maxNames:new Set(), minNames:new Set()};
      const nums = entries.map(([n,v])=>[n, parseFloat(v)]);
      const maxVal = Math.max(...nums.map(([,v])=>v));
      const minVal = Math.min(...nums.map(([,v])=>v));
      const maxNames = new Set(nums.filter(([,v])=>v===maxVal).map(([n])=>n));
      const minNames = new Set(nums.filter(([,v])=>v===minVal).map(([n])=>n));
      return {maxNames, minNames};
    }

    function clearEmptyState(){
      const es = document.getElementById('emptyState'); if(es) es.remove();
    }

    function songSortFn(a,b){
      const sel = sortByEl.value;
      if(sel==='avg_desc') return (b.avg)-(a.avg);
      if(sel==='avg_asc') return (a.avg)-(b.avg);
      if(sel==='title_asc') return a.title.localeCompare(b.title, undefined, {sensitivity:'base'});
      if(sel==='artist_asc') return a.artist.localeCompare(b.artist, undefined, {sensitivity:'base'});
      return (b.avg)-(a.avg);
    }

    function rerenderCards(){
      cardsEl.innerHTML = '';
      clearEmptyState();
      songs.sort(songSortFn);
      songs.forEach(song=> cardsEl.appendChild(renderCard(song)));
    }

    function refreshAllCards(){
      document.querySelectorAll('.card').forEach(card=>{
        const id = card.dataset.id;
        const song = songs.find(s=>s.id===id);
        if(song){
          card.replaceWith(renderCard(song));
        }
      });
    }

    function renderCard(song){
      const {maxNames, minNames} = getExtrema(song.scores);
      const card = document.createElement('article');
      card.className = 'card';
      card.dataset.id = song.id;

      // Apply layout
      const style = layoutStyleEl.value;
      card.classList.toggle('compact', style==='compact');
      card.classList.toggle('borderless', style==='borderless');

      // Header
      const title = document.createElement('div'); title.className='title'; title.textContent = song.title;
      const artist = document.createElement('div'); artist.className='artist'; artist.textContent = song.artist;
      card.appendChild(title); card.appendChild(artist);

      // Scores grid
      const scoresWrap = document.createElement('div'); scoresWrap.className='scores';
      roster.forEach(person=>{
        const rowL = document.createElement('div');
        const badge = document.createElement('span'); badge.className='badge';
        const chip = document.createElement('span'); chip.className='chip'; chip.textContent = person;
        badge.appendChild(chip);
        // submitter mark â€” if rater matches submitter OR their name ends with '/'
        const isSubmitter = (person && song.submitter && person.trim().toLowerCase()===song.submitter.trim().toLowerCase()) || /\/$/.test(person || '');
        if(isSubmitter){ const n=document.createElement('span'); n.className='markN'; n.title='Submitter'; n.textContent='N'; badge.appendChild(n); }
        rowL.appendChild(badge);

        const val = song.scores[person];
        const rowR = document.createElement('div');
        const sv = document.createElement('span'); sv.className='score'; sv.textContent = (val===undefined||val==='')? 'â€”' : String(val);
        if(maxNames.has(person)) sv.classList.add('high');
        if(minNames.has(person)) sv.classList.add('low');
        rowR.appendChild(sv);

        scoresWrap.appendChild(rowL);
        scoresWrap.appendChild(rowR);
      });
      card.appendChild(scoresWrap);

      // Average
      const avg = document.createElement('div'); avg.className='avg';
      avg.innerHTML = `<small>Average</small> ${Number.isFinite(song.avg)? song.avg.toFixed(2) : 'â€”'}`;
      card.appendChild(avg);

      // Actions
      const actions = document.createElement('div'); actions.className='card-actions';
      const dl = document.createElement('button'); dl.textContent = 'Export PNG'; dl.type='button';
      dl.addEventListener('click', ()=> downloadCardPNG(card, `${sanitizeFilename(song.title)}.png`));
      const del = document.createElement('button'); del.textContent = 'Delete'; del.type='button';
      del.addEventListener('click', ()=>{ songs = songs.filter(s=>s.id!==song.id); rerenderCards(); if(!songs.length){ showEmpty(); } });
      actions.appendChild(dl); actions.appendChild(del);
      card.appendChild(actions);

      return card;
    }

    function showEmpty(){
      const div = document.createElement('div'); div.className='empty'; div.id='emptyState'; div.textContent='No songs yet â€” add one above âœ¨';
      cardsEl.appendChild(div);
    }

    // Export helpers
    async function downloadCardPNG(cardEl, filename){
      // Temporarily force transparent background if borderless
      const originalBG = cardEl.style.backgroundColor;
      const originalBorder = cardEl.style.borderColor;
      // Ensure visual parity on export but with transparent background
      cardEl.style.backgroundColor = 'transparent';
      cardEl.style.borderColor = 'transparent';

      const canvas = await html2canvas(cardEl, {backgroundColor:null, scale:2});
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click();

      cardEl.style.backgroundColor = originalBG; cardEl.style.borderColor = originalBorder;
    }

    exportAllBtn.addEventListener('click', async()=>{
      const cards = [...document.querySelectorAll('.card')];
      for(const c of cards){
        const title = c.querySelector('.title')?.textContent?.trim() || 'song';
        await downloadCardPNG(c, `${sanitizeFilename(title)}.png`);
      }
    });

    layoutStyleEl.addEventListener('change', ()=>{
      document.querySelectorAll('.card').forEach(c=>{
        c.classList.toggle('compact', layoutStyleEl.value==='compact');
        c.classList.toggle('borderless', layoutStyleEl.value==='borderless');
      });
    });

    sortByEl.addEventListener('change', rerenderCards);

    // Form submit
    songForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const artist = document.getElementById('artist').value.trim();
      const submitter = document.getElementById('submitter').value.trim();
      const avgOverride = parseFloat(document.getElementById('avgOverride').value);

      const scores = {};
      [...scoreInputsEl.querySelectorAll('input')].forEach(inp=>{
        const who = inp.dataset.person; const val = inp.value.trim();
        if(val!=='' && !Number.isNaN(parseFloat(val))) scores[who] = parseFloat(val);
      });

      const avg = Number.isFinite(avgOverride) ? avgOverride : computeAverage(scores);

      addSong({ id: uid(), title, artist, submitter, scores, avg });
      songForm.reset(); rebuildScoreInputs();
    });

    document.getElementById('clearForm').addEventListener('click', ()=>{
      songForm.reset(); rebuildScoreInputs();
    });

    // init
    renderRosterInputs();
    rebuildScoreInputs();
    fillDatalist();
  </script>
</body>
</html>
